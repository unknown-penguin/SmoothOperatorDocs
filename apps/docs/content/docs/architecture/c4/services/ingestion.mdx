---
title: ingestion
description: Component diagram for the Ingestion Service (MQTT â†’ Kafka).
---

## Ingestion Service â€” Components

<Diagram lang="mermaid" chart={`
flowchart TD
  %% ============================================
  %% Ingestion Service Components (Go)
  %% ============================================

  subgraph Ingest["ðŸ§© Ingestion Service (Go)"]
    direction TB

    subgraph MQTTSub["ðŸ“¥ MQTT Subscription"]
      MQTTClient["MQTT Client\nTLS, topic filters\nQoS config"]
      Reconnect["Reconnect & Backoff\nexponential backoff\njitter"]
    end

    subgraph RxHTTP["ðŸŒ HTTP/gRPC Intake"]
      HTTPGRPC["RaceProvider Receiver\nREST & gRPC endpoints"]
      RateLimitIn["Ingress Rate Limiter\nburst control"]
    end

    subgraph Canon["ðŸ§¾ Canonicalization"]
      Normalizer["Normalizer\nmap topic â†’ canonical schema"]
      SchemaVal["Schema Validator\nJSON Schema\nreject malformed"]
      ContextJoin["Context Merger\njoin weather/flags/pos"]
    end

    subgraph Producers["ðŸ“¤ Kafka Producers"]
      ProdRaw["Producer: telemetry.raw.v1\nidempotent, acks=all"]
      ProdCtx["Producer: telemetry.context.v1\nidempotent, acks=all"]
      DLQ["Dead Letter Writer\npoison messages"]
    end

    subgraph Observability["ðŸ›¡ï¸ Resilience & Observability"]
      Health["Health/Ready Probes\n/health, /ready"]
      Metrics["Prometheus Exporter\nthroughput, errors, lag"]
      Logs["Structured Logs\nzap â†’ Loki"]
      CB["Circuit Breakers\nKafka/MQTT"]
    end
  end

  %% External
  MQTT["ðŸ”— MQTT Broker (infra)"]
  Kafka["ðŸ”€ Kafka Cluster (infra)"]

  %% Flows
  MQTT -->|"publish\ntelemetry/*"| MQTTClient
  MQTTClient --> Reconnect
  MQTTClient --> Normalizer

  HTTPGRPC --> RateLimitIn --> ContextJoin

  Normalizer --> SchemaVal --> ContextJoin

  ContextJoin --> ProdRaw
  ContextJoin --> ProdCtx
  SchemaVal -.->|"invalid"| DLQ

  ProdRaw -->|"produce"| Kafka
  ProdCtx -->|"produce"| Kafka

  %% Observability hooks
  MQTTClient -.->|"metrics/logs"| Metrics
  Producers -.->|"errors"| Logs
  Health -.-> MQTT
  Health -.-> Kafka
  CB -.->|"state changes"| Metrics

  %% Styling
  classDef go fill:#0ea5e9,stroke:#0369a1,color:#ffffff;
  classDef resilience fill:#ef4444,stroke:#dc2626,color:#ffffff;
  classDef infra fill:#374151,stroke:#111827,color:#ffffff;

  class Ingest,Normalizer,SchemaVal,ContextJoin,HTTPGRPC,MQTTClient,Reconnect,RateLimitIn,ProdRaw,ProdCtx,DLQ go;
  class Health,Metrics,Logs,CB resilience;
  class MQTT,Kafka infra;

  `} />

Notes: lightweight, horizontally scalable; keeps schema and mapping logic minimal; handles noisy devices and backpressure.
